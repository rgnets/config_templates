###############
# HSP TEMPLATE
###############
#
# This template will create a configuration based on a typical
# basic hospitality configuration.
# 
# Accounts are onboarded from a PMS system and users can
# authenticate via the captive portal using their last name + room
# number.
# 
# IMPORTANT:
# This template utilizes the built-in PMS emulator. Instructions for 
# configuration are located at the END of the template.
#
###############

#IMPORTANT: Please change these values to to match the target system
<%

wan_interface ||= 'igb0'
lan_interface ||= 'igb3'

%>
###############
# Template begins
###############

# Generate Policies
Policy:
- name: Management
- name: Premium
- name: Free
- name: Basic
  _delete: true
  
# Create PMS Server
# IMPORTANT:  See end of this template for simulator configuration
PmsServer:
- name: FIAS_Simulator
  interface: Fidelio
  host: 127.0.0.1
  port: 5010
  timeout: 30
  first_credential: RN
  second_credential: GN
  dd_format:
  - mac_decimal
  protocol: IP
  subsequent_transaction_max_count: 0
  subsequent_transaction_max_lifetime: 0
  subsequent_transaction_price_reduction: 0%
  ct_format:
  - dhcp_hostname
  - mac_vendor
  - usage_plan
  dd_length: 20
  ct_length: 40
  soap_endpoint: https://operademo3.microsdc.us
  soap_username: HTNG
  soap_password: HTNG
  revenue_code: '2'
  post_zero_charge: true
  account_sharing: guest
  show_only_matched_plans: true
  dup_timeout_seconds: 60
  enable_db_sync: true
  send_post_request: true
  service_code: WWW
  description_field: usage_plan_name
  transaction_code: '50'
  resort_ident: FSDH4
  itemizer_ident: '1'
  payment_ident: '0'
  revenue_center_ident: '1'
  automatic_login_fallback: false
  htng_username: OPERA
  htng_password: OPERA
  update_profile_email_mode: disabled
  resid_match: A
  portal_plan_override: true


# Subnet Filter to block traffic between VLANs/Subnets
SubnetsFilter:
- name: Block Subnets
  policies:
  - Basic
  - Post-Auth Landing
  - Pre-Auth / Guests
  - Premium

# Enable LLDP on LAN and WAN Interfaces
LadvdOption:
- name: default
  active: true
  auto_enable_protocols: true
  listen_only: false
  interfaces:
  - <%= lan_interface %>
  - <%= wan_interface %>

# Create Pre-Auth/Guest and Post-Auth VLANs and apply to LAN interface
Vlan:
- name: Pre-Auth / Guests
  interface: <%= lan_interface %>
  tag: 1100
  autoincrement_ratio: 8
  autoincrement_mode: address
- name: Post-Auth / Accounts
  interface: <%= lan_interface %>
  tag: 1108
  autoincrement_ratio: 1
  autoincrement_mode: address
  
# Apply IP addresses to VLANs  
Address:
- name: Pre-Auth / Guests
  vlan: Pre-Auth / Guests
  span: 1
  autoincrement: 64
  cidr: 10.0.0.1/30
- name: Post-Auth / Accounts
  vlan: Post-Auth / Accounts
  span: 1
  autoincrement: 110
  cidr: 10.0.1.1/24
  
# Create DHCP Pools for subnets
DhcpPool:
- name: Pre-Auth / Guests
  start_ip: 10.0.0.2
  end_ip: 10.0.0.254
  start_reserved: 0
  end_reserved: 0
  router_host_nth: 0
- name: Post-Auth / Accounts
  start_ip: 10.0.1.2
  end_ip: 10.0.110.254
  start_reserved: 0
  end_reserved: 0
  router_host_nth: 0
  
# Create IP Groups for subnets
IpGroup:
IpGroup:
- name: Pre-Auth / Guests
  priority: 5
  addresses:
  - Pre-Auth / Guests
- name: Post-Auth / Accounts
  priority: 2
  addresses:
  - Post-Auth / Accounts
  policy: Post-Auth Landing
  
# Create Radius Server
RadiusServerOption:
- name: Default
  active: true
  auth_port: 1812
  acct_port: 1813
  secret: lJCCtI9qMfDe_6R1OLGdXg
  radsec_port: 2083
  debug_level: normal
  min_tls_version: '1.2'
  max_tls_version: '1.2'
  policies:
  - Management
  
# Create Radius realms for Pre-Auth/Guest and Post-Auth WLANs
RadiusServer:
- name: Pre-Auth / Guests
  reuse_vlans: true
  vta_timeout_minutes: 60
  vlan_sharing: device
  unlimited_vlans_per_csid_mac: true
  rank: 2
  realm_admission_logic: or
  radius_server_attributes:
  - Tunnel-Type
  - Tunnel-Medium-Type
  - Tunnel-Private-Group-Id
  - name: Ruckus-DPSK
    value: "%account.pre_shared_key%"
    insertion_type: response
  vlans:
  - Pre-Auth / Guests
  radius_attribute_patterns:
  - id: 1
    radius_attribute: Called-Station-Id
    pattern: Start Here
    priority: 0
    logic: OR
- name: Post-Auth / Accounts
  vta_timeout_minutes: 60
  vlan_sharing: account
  unlimited_vlans_per_csid_mac: true
  rank: 0
  realm_admission_logic: or
  radius_server_attributes:
  - Tunnel-Type
  - Tunnel-Medium-Type
  - Tunnel-Private-Group-Id
  - Ruckus-DPSK
  vlans:
  - Post-Auth / Accounts
  policies:
  - Premium
  - Free
  - Basic

  
# Create Account Groups based on plans 
AccountGroup:
- name: Free
  policy: Free
  priority: 4
- name: Basic
  policy: Basic
  priority: 4
- name: Premium
  policy: Premium
  priority: 4
  
# Create Captive Portal for Splash and Landing
CaptivePortal:
- name: Default Splash
  portal_name: default
  background_automatic_login: mac
  portal_automatic_login: mac_or_cookie
  password_reset_method: secret_question
  role_attribute: none
  wan_targets:
  - name: Certificate Validation Hosts
    targets: |2

      ocsp.affirmtrust.com
      ocsp.comodoca.com
      ocsp.comodoca2.com
      ocsp.comodoca3.com
      ocsp.comodoca4.com
      ocsp.digicert.com
      cacerts.digicert.com
      crl3.digicert.com
      crl4.digicert.com
      ocsp.entrust.net
      ocsp.geotrust.com
      ocsp.globalsign.com
      ocsp2.globalsign.com
      crl.globalsign.com
      secure.globalsign.com
      ocsp.godaddy.com
      apps.identrust.com
      commercial.ocsp.identrust.com
      r3.i.lencr.org
      r3.o.lencr.org
      x1.c.lencr.org
      ocsp.netsolssl.com
      ocsp.omniroot.com
      ocsp.quovadisglobal.com
      ocsp.root-x1.letsencrypt.org
      ocsp.starfieldtech.com
      ocsp.startssl.com
      ocsp.swisssign.net
      ocsp.thawte.com
      ocsp.trust-provider.com
      ocsp.trustwave.com
      ocsp.usertrust.com
      ocsp.verisign.com
      ocsp.wosign.com
      ocsp.ws.symantec.com
      ocsp1.wosign.com
      ocsp2.wosign.cn
      zerossl.crt.sectigo.com
      zerossl.ocsp.sectigo.com
    sync_frequency: none
  - name: PayPal
    targets: |2

      paypal.com
      *.paypal.com
      *.paypalobjects.com
      *.ebaystatic.com
    sync_frequency: none
  policies:
  - Pre-Auth / Guests
LandingPortal:
- name: Default Landing
  portal_name: default
  unlimited_session_minutes: true
  idle_minutes: 20
  session_grace_minutes: 15
  portal_automatic_login: mac_or_cookie
  background_automatic_login: mac
  policies:
  - Premium
  - Free
  - Basic
  - Post-Auth Landing

# Create Billing merchants
Merchant:
- name: Authorize.Net
  gateway: AuthorizeNet
  store_payment_methods: true
  login: 74J3dDPgf
  password: 9z8ze9L8CYu2Y85K
  signature: 15437467B191351CCB81F9AD6B6A275FF398F3A98314776107995720B1F1CB6F75D9FB275FA3A403EC0B9BE79BAA36C67492FFED73EF2E911379305C671DA2A3
  dup_timeout_seconds: 60
- name: Paypal
  login: tcb@rgnets.com
  integration: Paypal
  dup_timeout_seconds: 60
  
# Create Plans
TimePlan:
- name: Unlimited
  price: 0.0
  unlimited_usage_minutes: true
QuotaPlan:
- name: Unlimited
  price: 0.0
  unlimited_usage_mb_up: true
  unlimited_usage_mb_down: true
  
UsagePlan:
- name: 1 Day Basic
  account_group: Basic
  currency: USD
  recurring_method: none
  variable_recurring_day: true
  automatic_login: true
  time_plan: Unlimited
  quota_plan: Unlimited
  usage_lifetime_time: 1
  recurring_retry_grace_minutes: 1440
  recurring_fail_limit: 5
  lock_devices: true
  max_sessions: 3
  unlimited_devices: true
  usage_lifetime_time_unit: days
  max_dedicated_ips: 0
  pms_guest_match_operator: OR
  recurring_lifetime_time_unit: months
  unlimited_recurring_lifetime: true
  validation_method: none
  validation_grace_minutes: 0
  max_party_devices: 0
  captive_portals:
  - Default Splash
  landing_portals:
  - Default Landing
  merchants:
  - Paypal
  plan_addons:
  - name: 1 Day Premium
    fixed_price: 9.99
    component: account_group
    account_group: Premium
- name: 2 Day Basic
  account_group: Basic
  currency: USD
  recurring_method: none
  variable_recurring_day: true
  automatic_login: true
  time_plan: Unlimited
  quota_plan: Unlimited
  usage_lifetime_time: 2
  recurring_retry_grace_minutes: 1440
  recurring_fail_limit: 5
  lock_devices: true
  max_sessions: 3
  unlimited_devices: true
  usage_lifetime_time_unit: days
  max_dedicated_ips: 0
  pms_guest_match_operator: OR
  recurring_lifetime_time_unit: months
  unlimited_recurring_lifetime: true
  validation_method: none
  validation_grace_minutes: 0
  max_party_devices: 0
  captive_portals:
  - Default Splash
  landing_portals:
  - Default Landing
  merchants:
  - Paypal
  plan_addons:
  - name: 2 Day Premium
    fixed_price: 17.99
    component: account_group
    account_group: Premium
- name: 3 Day Basic
  account_group: Basic
  currency: USD
  recurring_method: none
  variable_recurring_day: true
  automatic_login: true
  time_plan: Unlimited
  quota_plan: Unlimited
  usage_lifetime_time: 3
  recurring_retry_grace_minutes: 1440
  recurring_fail_limit: 5
  lock_devices: true
  max_sessions: 3
  unlimited_devices: true
  usage_lifetime_time_unit: days
  max_dedicated_ips: 0
  pms_guest_match_operator: OR
  recurring_lifetime_time_unit: months
  unlimited_recurring_lifetime: true
  validation_method: none
  validation_grace_minutes: 0
  max_party_devices: 0
  captive_portals:
  - Default Splash
  landing_portals:
  - Default Landing
  merchants:
  - Paypal
  plan_addons:
  - name: 2 Day Premium
    fixed_price: 17.99
    component: account_group
    account_group: Premium

# Create Traffic Shaping rules
BandwidthQueue:
- name: Infrastructure
  upload_bw: 100
  upload_bw_unit: "%"
  download_bw: 100
  download_bw_unit: "%"
  priority: 0
  rt_upload_bw_unit: Mbps
  rt_download_bw_unit: Mbps
  burst_upload_bw_unit: Mbps
  burst_download_bw_unit: Mbps
  sharing: group
  disable_auto_ip_queues: true
  policies:
  - Management
- name: 3x1 Mbps with burst
  upload_bw: 1
  upload_bw_unit: Mbps
  download_bw: 3
  download_bw_unit: Mbps
  priority: 0
  rt_upload_bw_unit: Mbps
  rt_download_bw_unit: Mbps
  burst_upload_bw: 2
  burst_upload_bw_unit: Mbps
  burst_download_bw: 10
  burst_download_bw_unit: Mbps
  burst_ms: 5000
  sharing: ip
  policies:
  - Free
- name: 100%
  upload_bw: 100
  upload_bw_unit: "%"
  download_bw: 100
  download_bw_unit: "%"
  priority: 0
  rt_upload_bw_unit: Kbps
  rt_download_bw_unit: Kbps
  burst_upload_bw_unit: Kbps
  burst_download_bw_unit: Kbps
  sharing: ip
  policies:
  - Pre-Auth / Guests
  - Post-Auth Landing
- name: 50x50 Mbps per account
  upload_bw: 50
  upload_bw_unit: Mbps
  download_bw: 50
  download_bw_unit: Mbps
  priority: 0
  rt_upload_bw_unit: Mbps
  rt_download_bw_unit: Mbps
  burst_upload_bw_unit: Mbps
  burst_download_bw_unit: Mbps
  sharing: account
  policies:
  - Premium
- name: 20x20 Mbps per account
  upload_bw: 20
  upload_bw_unit: Mbps
  download_bw: 20
  download_bw_unit: Mbps
  priority: 0
  rt_upload_bw_unit: Mbps
  rt_download_bw_unit: Mbps
  burst_upload_bw_unit: Mbps
  burst_download_bw_unit: Mbps
  sharing: account
  policies:
  - Basic
  
Squid:
- name: Cache
  _delete: true
  
########
# Template ends
########

########
#PMS Emulator instructions:
########

# Step 1) Access the CLI and elevate to root
# Step 2) Create file /etc.local.hook with the following contents
#
#        ##!/bin/sh
#
#         /space/rxg/rxgd/debug/gen_fias_guest_list > /space/guest_list.csv
#         nohup /space/rxg/rxgd/debug/fias_server.py -g /space/guest_list.csv &
#
# Step 3) Make this file executable and run it.  A PMS emulator with a new csv list of random tenants and room
#         numbers will be generated for the rXg to connect to.
#
#  Please reference https://www.reddit.com/r/RGNets/comments/uo9r5r/the_rxg_includes_a_fias_property_management/
